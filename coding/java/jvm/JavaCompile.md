# Java编译到执行

## Java跨平台的原因

Java是一门跨平台的语言，也就是”一次编写，到处运行“。主要原因是java运行在JVM上，JVM封装了物理机器的实现细节。我们平时使用Java开发不用管平台，但安装JDK或JRE是就会选择具体的平台，所以Java是将平台的依赖性封装在了JVM里，Java程序就不用在考虑平台移植性问题。

## 源文件(.java)到执行的过程

在谈执行过程前，需要了解一件事，就是二进制计算机只认识01机器代码或者说是汇编码(汇编只是机器码的一种记法，可以查表直接转换)，因此不管是什么语言最后都需要转换成汇编代码再执行(可以是编译执行C\C++,或者解释执行python,javascript)，在此前提下来分析java的执行过程。

总的来说，java的执行过程分为编译、加载、解释执行几个阶段

### 编译

将源码文件编译成JVM可以解释的class文件

编译过程会对源代码进行：语法分析、语义分析、注解处理等步骤。

比如泛型的擦除和常用类的Lombok注解就是在编译阶段干的。

### 加载

将编译后的class文件加载到JVM中。

加载阶段可以细分为：
1. 装载: 
    - 装载时机：为了节省内存开销，并不会一次性把所有的类都装载至JVM，而是按需加载，比如使用这个类的静态变量或方法、new以及反射等时机。
    - 装载方式：class文件是通过类加载器装载到JVM中的，为了防止用户覆盖Java的核心类，使用双亲委派机制(不会首先尝试自己加载这个类，而是将请求委托类父类加载器去完成，依次向上，只有最上层的加载器无法加载才会让下层加载器尝试加载)
    - 装载规则：JDK中的本地(native)方法类又根加载器(Bootstrap loader)装载，JDK中内部实现的扩展类由扩展加载器(ExtClassLoader)装载，程序中的类文件由系统加载器(AppClassLoader)实现装载。
    - 工作过程：查找并加载类的二进制文件、在JVM的堆中创建一个java.lang.Class类的对象，并将相关的信息存储在方法区中。
2. 连接: 
    - 验证：验证类是否符合Java规范和JVM规范
    - 准备：为类的静态变量分配额内存、初始化为系统的初始值
    - 解析：将符号引用转为直接引用的过程
3. 初始化： 
    为类的静态变量赋予正确的初始值：收集class
    的静态变量、静态代码块、静态方法，随后从上往下开始执行。如果静态代码块中有对象的初始化，就执行对应构造方法内的代码。

### 解释

当尝试加载一个类的方法时，会找到对应方法的字节码的信息，然后解释器会把字节码信息解释成相应机器的汇编码格式。

将字节码解释成机器机器指令有两种方式：
1. 字节码解释器：
2. 即时编译器(JIT)：

JVM会对`热点代码`做编译，非热点代码直接进行解释。当JVM发现某个方法或代码块的运行十分频繁时，就有可能把这部分代码指定为热点代码

热点探测有两种方式：基于抽样、基于计数。

Hospot虚拟机是基于计数(计数每隔一点时间变小，表示调用频繁程度)的方式来进行探测的，包括`方法调用计数器`以及`回边计数器`，一旦计数器超过阈值，就会出发JIT编译，同时将指令码缓存起来，下次直接使用。

### 执行

CPU加载解释器解析出来的指令码执行。
