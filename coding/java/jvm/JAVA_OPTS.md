# JVM调优

## JVM调优思路

> 在理解JVM内存结构以及各种垃圾收集器前提下，结合自己现有的业务来调整参数，使自己的应用能够正常稳定运行。

调优常用指标：
- 吞吐量
- 停顿时间
- 垃圾回收频率

基于以上指标，可以调节：
- 内存区域大小以及相关策略
    > 按照经验来说: IO密集型的可以把新生代比例调大、因为大多数对象在新生代就会灭亡，内存密集型的可以把老年代调大一点，对象存活时间更长。
    - -Xmx:设置最大堆的大小
    - -Xms:设置堆的初始值
    - -Xmn:新生代的大小
    - XX:SurvivorRatio:Eden和Survivor的比例(默认为8，表示Eden:From:To=8:1:1)

- 垃圾回收器
    > 选择合适的垃圾回收器，以及各个垃圾回收器的各种调优
    - -XX:UseG1GC: 指定垃圾回收器为G1
    - -XX:MaxGCPauseMillis: 设置目标停顿时间
    - -XX:InitiatingHeapOccupancyPercent： 当整个堆的使用达到一定比例，全局并发标记额阶段就会启动等等

## 检测工具

进行JVM调优首先的知道是什么问题引起的才好对症下药，需要使用各种工具进行排查：

- jps: 查看Java进程基础信息，进程号，主类
- jstat: 查看Java进程统计类相关信息，类加载、编译相关信息统计、各个内存区域GC概况和统计
- jinfo: 查看和调整java进程的运行参数
- jmap: 查看java进程内存信息，一般将JVM内存信息dump到文件，然后再使用MAT(Memory Analyzer tool内存解析工具)进行分析
- jstack:查看JVM线程信息，可以用于排查死锁
- Arthas: 阿里开源诊断工具，覆盖以上命令二功能并带有图形化界面。

## JIT优化技术

- 方法内联

    将目标方法复制到调用方法中，避免真实的方法调用，因为每次方法调用都会生成栈帧会带来一定的性能损耗，所以方法内联的优化可以提高一定的性能。设置方法内联参数：
    - -XX:MaxFreqInlineSize
    - -XX:MaxInlineSize

- 逃逸分析

    逃逸分析就是判断一个对象是否被外部方法引用或外部线程访问的分析技术，如果没有被引用，就可以对其进行优化，包括：
    1. 锁消除：该对象只在方法内部被访问、不会被其它地方引用，那么就一定是线程安全的，可以把所相关的代码忽略掉。
    2. 栈上分配：该对象的作用域是方法内部，直接将方法分配在栈上，方法结束自动弹出，避免不必要的垃圾回收。
    3. 标量替换：这是和栈上分配一起使用的，将对象分配在栈上时，实际上是将对象的成员变量当作方法局部变量放在栈上。

<br>
<br>

👉[Java中9种常见的CMS GC问题分析与解决](https://mp.weixin.qq.com/s?__biz=MjM5NjQ5MTI5OA==&mid=2651754955&idx=1&sn=8411133d2e5f22b9e2c5a34cdc67985d&scene=21#wechat_redirect)